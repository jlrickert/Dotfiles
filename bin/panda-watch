#!/bin/sh

BIN="$(command -v pandoc)"
if [ ! -x $BIN ]; then
    exit
fi

CSS="$HOME/.local/share/pandoc/pandoc-notes.css"
CSL="$HOME/.local/share/pandoc/csl/chicago-note-bibliography.csl"
BIB="$HOME/.local/share/pandoc/bibliography.bib"
TEMPLATE="$HOME/.local/share/pandoc/notes.html5"
PANDOC_HTML_OPTS="\
--standalone \
--toc \
--smart \
--mathjax \
--filter=pandoc-citeproc \
--csl=$CSL \
--bibliography=$BIB \
--css=$CSS \
--template=$TEMPLATE"

TMP_DIR="/tmp/$USER"

MD_FILE="$@"
MD_PATH=`readlink -f "$MD_FILE"`
HTML_FILE="$TMP_DIR/`echo $MD_FILE | sed -e 's/md$/html/'`"

CMD="$BIN $PANDOC_HTML_OPTS -o $HTML_FILE $MD_PATH"

FORMAT=$(echo -e "\033[1;33m%w%f\033[0m written.")
eval "$CMD"
firefox $HTML_FILE
while inotifywait -qre close_write --format "$FORMAT" .
do
    eval "$CMD"
done

