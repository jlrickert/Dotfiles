#!/bin/sh

BACKUP_DIR=/home/$USER/Sync
REPOSITORY=/home/$USER/Sync.backup

info() {
    printf "\n%s %s\n\n" "$(date)" "$*" >&2;
}

trap 'echo $( date ) Backup interrupted >&2; exit 2' INT TERM

info "Starting backup"

borg create                            \
    --verbose                          \
    --filter AME                       \
    --list                             \
    --stats                            \
    --compression lz4                  \
    --exclude-caches                   \
                                       \
    ${REPOSITORY}::'Sync-{now}'        \
    $BACKUP_DIR                        \

backup_exit=$?

info "Pruning reposity"

borg prune           \
    --list           \
    --show-rc        \
    --keep-daily   7 \
    --keep-weekly  4 \
    --keep-monthly 6 \
    $REPOSITORY      \

prune_exit=$?

global_exit=$(( backup_exit > prune_exit ? backup_exit : prune_exit ))

if [ ${global_exit} -eq 1 ];
then
    info "Backup and/or Prune finished with a warning"
fi

if [ ${global_exit} -gt 1 ];
then
    info "Backup and/or Prune finished with an error"
fi

exit ${global_exit}
